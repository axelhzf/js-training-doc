<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Persistencia con mongodb | js-training</title>
  <link rel="stylesheet" href="/styles/main.css">
</head>
<body>
  <header>
    <div class="logo">JS<small>training</small></div>
  </header>
  <div class="content"><h1 id="introducci-n">Introducción</h1>
<p>MongoDB es una base de datos NoSQL, open source que fue lanzada en 2009. Las base de datos NoSQL se diferencian de las bases de datos relacionales en que los datos no se almacenan en tablas sino en estructuras de datos de tipo JSON. Esto hace que trabajar con MongoDB y JavaScript sea muy natural, no es necesario transformar los datos de tablas o objetos. La principal ventaja de las bases de datos NoSQL es que no requieren un esquema de información fijo y que ofrecen una alta escalabilidad. NoSQL no es la mejor opción en todos los casos, hay que estudiar el caso concreto y analizar el tipo de datos que vamos a manejar.</p>
<p>Existen muchas otras bases de datos NoSQL como <a href="https://github.com/felixge/node-couchdb">CouchDB</a>, <a href="https://github.com/mranney/node_redis">Redis</a> o <a href="https://github.com/racker/node-cassandra-client">Cassandra</a>. Si prefieres utilizar base de datos relacionales también existen clientes para node: <a href="https://github.com/felixge/node-mysql">MySQL</a> o <a href="https://github.com/brianc/node-postgres">PostgreSQL</a>.</p>
<h1 id="mongo-instalaci-n">Mongo instalación</h1>
<p>Para la instalación de mongo seguimos los pasos de la <a href="http://docs.mongodb.org/manual/installation/">documentación oficial</a>. En el caso de OSX, recomiendan hacer la instalación con homebrew.</p>
<pre><code class="lang-bash"><span class="hljs-variable">$ </span>brew install mongo
</code></pre>
<p>Para arrancar la base de datos</p>
<pre><code class="lang-bash"><span class="hljs-variable">$ </span>mongod
</code></pre>
<p>Para acceder a la base de datos con el cliente</p>
<pre><code class="lang-bash"><span class="hljs-variable">$ </span>mongo
</code></pre>
<p>Podemos probar a ejecutar algunas sentencias</p>
<pre><code class="lang-bash">&gt; db<span class="hljs-preprocessor">.test</span><span class="hljs-preprocessor">.save</span>( { a: <span class="hljs-number">1</span> } )
&gt; db<span class="hljs-preprocessor">.test</span><span class="hljs-preprocessor">.find</span>()
</code></pre>
<h1 id="mongo-comandos-b-sico">Mongo comandos básico</h1>
<p>Primero vamos a aclarar algunos términos. En MongoDB puedes tener varias bases de datos exactamente igual que con MySQL. Pero dentro de esas base de datos no hay tablas, hay colecciones. Puedes entender una colección como una tabla exceptuando que una colección no tiene por qué tener un número de columnas fijas. Por ejemplo, si tenemos una colección de usuario, un usuario puede tener los campos nombre y apellido, mientras que otro puede tener nombre y email. Dentro de las colección tenemos documentos, que siguiendo el símil con el modelo de datos relacional, serían las filas de las tablas.</p>
<p>En esta página de documentación tienes una <a href="http://docs.mongodb.org/manual/reference/javascript/">referencia rápida a los comandos básicos</a>.</p>
<pre><code class="lang-js">&gt; show dbs
&gt; use mydb
&gt; db
&gt; db<span class="hljs-preprocessor">.users</span><span class="hljs-preprocessor">.insert</span>({name : <span class="hljs-string">"luke"</span>, lastName : <span class="hljs-string">"skywalker"</span>})
&gt; db<span class="hljs-preprocessor">.users</span><span class="hljs-preprocessor">.insert</span>({lastName : <span class="hljs-string">"kent"</span>, email : <span class="hljs-string">"clark@dailyplanet.com"</span>})<span class="hljs-comment">;</span>
&gt; show collections
&gt; db<span class="hljs-preprocessor">.users</span><span class="hljs-preprocessor">.find</span>()
&gt; db<span class="hljs-preprocessor">.users</span><span class="hljs-preprocessor">.find</span>({name : <span class="hljs-string">"luke"</span>})
&gt; db<span class="hljs-preprocessor">.users</span><span class="hljs-preprocessor">.findOne</span>()
&gt; db<span class="hljs-preprocessor">.users</span><span class="hljs-preprocessor">.find</span>()<span class="hljs-preprocessor">.limit</span>(<span class="hljs-number">1</span>) 
&gt; db<span class="hljs-preprocessor">.users</span><span class="hljs-preprocessor">.find</span>()<span class="hljs-preprocessor">.sort</span>({name : <span class="hljs-number">1</span>})
&gt; db<span class="hljs-preprocessor">.users</span><span class="hljs-preprocessor">.find</span>()<span class="hljs-preprocessor">.sort</span>({name : -<span class="hljs-number">1</span>})
&gt; db<span class="hljs-preprocessor">.users</span><span class="hljs-preprocessor">.count</span>()
&gt; db<span class="hljs-preprocessor">.users</span><span class="hljs-preprocessor">.update</span>({lastName : <span class="hljs-string">"kent"</span>}, {$<span class="hljs-keyword">set</span> : {name : <span class="hljs-string">"clark"</span>}})
&gt; db<span class="hljs-preprocessor">.users</span><span class="hljs-preprocessor">.find</span>()
&gt; db<span class="hljs-preprocessor">.users</span><span class="hljs-preprocessor">.remove</span>({name : <span class="hljs-string">"luke"</span>})
&gt; db<span class="hljs-preprocessor">.users</span><span class="hljs-preprocessor">.remove</span>()
</code></pre>
<p>Yo vengo del mundo de las base de datos relacionales y algo que me ayudó bastante al principio es esta <a href="http://docs.mongodb.org/manual/reference/sql-comparison/">página de documentación</a> que compara cómo harías las cosas en SQL frente a como lo harías en MongoDB.</p>
<h1 id="mongodb-y-node-js">MongoDB y Node.js</h1>
<p>Para Node.js tenemos el <a href="https://github.com/mongodb/node-mongodb-native">cliente nativo</a> que nos permite trabajar directamente con la base de datos. Nuestro caso es bastante sencillo y esto nos podría bastar más que de sobra, pero vamos a utilizar una librería por encima de más alto nivel, <a href="http://mongoosejs.com/">mongoose</a>.</p>
<pre><code class="lang-bash"><span class="hljs-comment">$</span> <span class="hljs-comment">npm</span> <span class="hljs-comment">install</span> <span class="hljs-comment">mongoose</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">save</span>
</code></pre>
<p>Crea el primer modelo para almacenar usuarios en <code>modelos/User.js</code></p>
<pre><code class="lang-js"><span class="hljs-built_in">var</span> mongoose <span class="hljs-subst">=</span> <span class="hljs-keyword">require</span>(<span class="hljs-string">'mongoose'</span>);
<span class="hljs-built_in">var</span> Schema <span class="hljs-subst">=</span> mongoose<span class="hljs-built_in">.</span>Schema;

<span class="hljs-built_in">var</span> userSchema <span class="hljs-subst">=</span> <span class="hljs-literal">new</span> Schema({
    username : {
        <span class="hljs-keyword">type</span> : <span class="hljs-built_in">String</span>,
        required : <span class="hljs-literal">true</span>,
        index : { unique : <span class="hljs-literal">true</span> }
    },
    password : {
        <span class="hljs-keyword">type</span> : <span class="hljs-built_in">String</span>,
        required : <span class="hljs-literal">true</span>
    },
    creation_date : {<span class="hljs-keyword">type</span> : <span class="hljs-built_in">Date</span>, default : <span class="hljs-built_in">Date</span><span class="hljs-built_in">.</span>now}
});

<span class="hljs-built_in">var</span> User <span class="hljs-subst">=</span> mongoose<span class="hljs-built_in">.</span>model(<span class="hljs-string">'User'</span>, userSchema);

module<span class="hljs-built_in">.</span>exports <span class="hljs-subst">=</span> User;
</code></pre>
<p>En el esquema estamos definiendo que tanto el campo username como password son campos requeridos. Y que la fecha de creación por defecto va a ser la fecha actual.</p>
<p>Tal como planteamos el formulario de login. Únicamente hacemos login, no tenemos formulario de registro. Vamos a añadir un método estático al modelo user que haga esto:</p>
<ul>
<li>En caso de que no exista el username lo creamos</li>
<li>En caso de que exista, comprobamos que la contraseña sea la misma y devolvemos el usuario</li>
</ul>
<pre><code class="lang-js">userSchema.statics.login = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(attributes, cb)</span> {</span>
    <span class="hljs-keyword">var</span> Model = <span class="hljs-keyword">this</span>;
    Model.findOne({username : attributes.username}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, user)</span> {</span>
        <span class="hljs-keyword">if</span> (user) {
            <span class="hljs-keyword">if</span>( attributes.password !== user.password) {
                cb(<span class="hljs-string">"Invalid"</span>);
            } <span class="hljs-keyword">else</span> {
                cb(<span class="hljs-literal">null</span>, user);
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">var</span> newUser = <span class="hljs-keyword">new</span> Model(attributes);
            newUser.save(cb);
        }
    });
};
</code></pre>
<p>Vamos a crear unos tests para probar este método</p>
<pre><code class="lang-js"><span class="hljs-keyword">var</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);
<span class="hljs-keyword">var</span> expect = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chai'</span>).expect;
<span class="hljs-keyword">var</span> User = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../../../model/User.js"</span>);

describe(<span class="hljs-string">"User"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>

    before(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> {</span>
        mongoose.connect(<span class="hljs-string">'mongodb://localhost/donotdisturb-test'</span>);
        <span class="hljs-keyword">var</span> db = mongoose.connection;
        db.once(<span class="hljs-string">"open"</span>, done);
    });

    beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> {</span>
        User.remove(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            done();
        });
    });

    describe(<span class="hljs-string">"login"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>

        it(<span class="hljs-string">"should create a user if username not exists"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> {</span>
            User.login({username : <span class="hljs-string">"Dwight Schrute"</span>, password : <span class="hljs-string">"beet"</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, user)</span> {</span>
                expect(user.id).not.to.be.undefined;
                done();
            });
        });

        it(<span class="hljs-string">"should return the user if the username ant the password are correct"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> {</span>
            <span class="hljs-keyword">var</span> userData = {username : <span class="hljs-string">"Dwight Schrute"</span>, password : <span class="hljs-string">"beet"</span>};
            User.login(userData, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, userCreation)</span> {</span>
                User.login(userData, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, userLogin)</span> {</span>
                    expect(userLogin.id).to.be.equal(userCreation.id);
                    done();
                })
            });
        });

        it(<span class="hljs-string">"should return error if the password is incorrect"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> {</span>
            <span class="hljs-keyword">var</span> userData = {username : <span class="hljs-string">"Dwight Schrute"</span>, password : <span class="hljs-string">"beet"</span>};
            User.login(userData, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, userCreation)</span> {</span>
                userData.password = <span class="hljs-string">'incorrect'</span>;
                User.login(userData, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, userLogin)</span> {</span>
                    expect(err).to.equal(<span class="hljs-string">"Invalid"</span>);
                    done();
                })
            });
        });
    });

});
</code></pre>
<h1 id="referencias">Referencias</h1>
<ul>
<li><a href="http://mongoosejs.com/">http://mongoosejs.com/</a></li>
<li></li>
</ul>

  </div>
  <footer><a href="http://twitter.com/axelhzf" about="_blank">Twitter</a><a href="http://github.com/axelhzf" about="_blank">Github</a></footer>
</body>