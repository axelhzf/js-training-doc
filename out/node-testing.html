<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Testing Node.js Applications | js-training</title>
  <link rel="stylesheet" href="/styles/main.css">
</head>
<body>
  <header>
    <div class="logo">JS<small>training</small></div>
  </header>
  <div class="content"><p>Ya tenemos una funcionalidad básica de nuestra aplicación. Vamos a ver cómo podemos testearla. En esta sección vamos a ver cómo hacer dos tipos de tests: unitarios y de integración.</p>
<h1 id="dependencias">Dependencias</h1>
<p>Como framework de test utilizaremos mocha, pero esta vez no utilizaremos la versión del navegador, sino que lo instalaremos como un módulo.</p>
<pre><code class="lang-bash"><span class="hljs-comment">$</span> <span class="hljs-comment">npm</span> <span class="hljs-comment">install</span> <span class="hljs-comment">mocha</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">save</span>
<span class="hljs-comment">$</span> <span class="hljs-comment">npm</span> <span class="hljs-comment">install</span> <span class="hljs-comment">chai</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">save</span>
<span class="hljs-comment">$</span> <span class="hljs-comment">npm</span> <span class="hljs-comment">install</span> <span class="hljs-comment">sinon</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">save</span>
</code></pre>
<p>Estas dependencias las utilizaremos en los test, así que mejor si modifica el fichero package.json para incluir estas dependencias en el grupo de <code>devDependencies</code>.</p>
<p>Además de mocha y chai, que ya conocemos. Vamos a utilizar <a href="http://sinonjs.org/">sinon.js</a>, una librería de spies, stubs y mocks. </p>
<h1 id="tests-unitarios">Tests unitarios</h1>
<p>Vamos a empezar creando un test unitario del middleware de seguridad que creamos en la sección anterior. Esta función se encargaba de redirigir a la página de login en el caso de que el usuario no tuviera una sesión creada.</p>
<p>Crea un fichero <code>test/unit/securityTest.js</code>.</p>
<pre><code class="lang-js">var expect = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chai'</span>).expect;
var sinon = <span class="hljs-built_in">require</span>(<span class="hljs-string">'sinon'</span>);
var security = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../../app/security'</span>)

describe(<span class="hljs-string">"security"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span></span> {

    var request, response, <span class="hljs-built_in">next</span>;

    beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span></span> {
        request = {
            session : {}
        };
        response = {
            redirect : sinon.spy()
        }
        <span class="hljs-built_in">next</span> = sinon.spy();
    });

    it(<span class="hljs-string">"should redirect to login if not session"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span></span> {
        security(request, response, <span class="hljs-built_in">next</span>);
        expect(response.redirect.calledWith(<span class="hljs-string">"/login"</span>)).to.be.<span class="hljs-keyword">true</span>;
        expect(<span class="hljs-built_in">next</span>.called).to.be.<span class="hljs-keyword">false</span>;
    });

    it(<span class="hljs-string">"should continue the chain if there is a session"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span></span> {
        request.session.username = <span class="hljs-string">'superman'</span>;
        security(request, response, <span class="hljs-built_in">next</span>);
        expect(response.redirect.called).to.be.<span class="hljs-keyword">false</span>;
        expect(<span class="hljs-built_in">next</span>.called).to.be.<span class="hljs-keyword">true</span>;
    });

});
</code></pre>
<p>En primer lugar este código hace los require de chai, sinon y del módulo de seguridad que vamos a testear. En el método <code>beforeEach</code> preparamos los objetos de request, response y next. El primer test, comprueba que cuando no hay username en la sesión se llama al método redirect. En el segundo se comprueba que cuando existe un username en la sesión se llama a next.</p>
<p>Para ejecutar los tests ejecuta el comando</p>
<pre><code class="lang-js"><span class="hljs-variable">$ </span>mocha test/unit
</code></pre>
<h1 id="ejercicio">Ejercicio</h1>
<p>Crea un test unitario para el módulo messages. Recuerda que la funcionalidad de este módulo era transforma el formato de los mensajes que estan en <code>req.flash</code> en una lista de objeto con type y text.</p>
<h1 id="soluci-n">Solución</h1>
<pre><code class="lang-js">var expect = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chai'</span>).expect;
var sinon = <span class="hljs-built_in">require</span>(<span class="hljs-string">'sinon'</span>);
var messages = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../../app/messages.js'</span>)

describe(<span class="hljs-string">"messages"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span></span> {

    it(<span class="hljs-string">"should transform the flash messages"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span></span> {
        var <span class="hljs-built_in">next</span> = sinon.spy();
        var req = {
            flash : <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span></span> {
                <span class="hljs-keyword">return</span> {<span class="hljs-string">"info"</span> : [<span class="hljs-string">"info1"</span>, <span class="hljs-string">"info2"</span>], <span class="hljs-string">"error"</span> : [<span class="hljs-string">"error1"</span>]};
            }
        };
        var res = {
            locals : {}
        };
        messages(req, res, <span class="hljs-built_in">next</span>)
        expect(<span class="hljs-built_in">next</span>.called).to.be.<span class="hljs-keyword">true</span>;
        expect(res.locals.messages()).to.deep.equal(
            [
                {<span class="hljs-built_in">type</span>: <span class="hljs-string">'info'</span>, text : <span class="hljs-string">"info1"</span>},
                {<span class="hljs-built_in">type</span>: <span class="hljs-string">'info'</span>, text : <span class="hljs-string">"info2"</span>},
                {<span class="hljs-built_in">type</span>: <span class="hljs-string">'error'</span>, text : <span class="hljs-string">"error1"</span>}
            ]
        );
    });

});
</code></pre>
<h1 id="tests-de-integraci-n">Tests de integración</h1>
<p>Para los test de integración vamos a levantar el servidor y vamos hacer peticiones. Vamos a añadir un cliente http para poder hacer peticiones a nuestro propio servidor. Igual que en el caso anterior, añade a las dependencias de desarrollo.</p>
<pre><code class="lang-bash"><span class="hljs-comment">$</span> <span class="hljs-comment">npm</span> <span class="hljs-comment">install</span> <span class="hljs-comment">request</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">save</span>
</code></pre>
<pre><code class="lang-js"><span class="hljs-keyword">var</span> expect = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chai'</span>).expect;
<span class="hljs-keyword">var</span> request = <span class="hljs-built_in">require</span>(<span class="hljs-string">'request'</span>);
<span class="hljs-keyword">var</span> app = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../../app.js'</span>);

describe(<span class="hljs-string">"login"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>

    it(<span class="hljs-string">"should redirect to login page"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> {</span>
        <span class="hljs-keyword">var</span> options = {
            url : <span class="hljs-string">'http://localhost:3000'</span>,
            followRedirect : <span class="hljs-literal">false</span>
        };

        request(options, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(error, response, body)</span> {</span>
            expect(response.statusCode).to.equal(<span class="hljs-number">302</span>);
            expect(response.headers.location).to.equal(<span class="hljs-string">"/login"</span>);
            done();
        });
    });

    it(<span class="hljs-string">"should redirect to / if credentials are ok"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> {</span>
        <span class="hljs-keyword">var</span> options = {
            url : <span class="hljs-string">'http://localhost:3000/login'</span>,
            followRedirect : <span class="hljs-literal">false</span>,
            form : {username : <span class="hljs-string">"user1"</span>, password : <span class="hljs-string">"user1"</span>}
        };

        request.post(options, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(error, response, body)</span> {</span>
            expect(response.statusCode).to.equal(<span class="hljs-number">302</span>);
            expect(response.headers.location).to.equal(<span class="hljs-string">"/"</span>);
            expect(response.headers[<span class="hljs-string">'set-cookie'</span>][<span class="hljs-number">0</span>]).to.have.string(<span class="hljs-string">'connect.sess'</span>);
            done();
        });
    });

});
</code></pre>
<p>En este código estamos haciendo un require de chai y de request. Además estamos incluyendo el servidor (&#39;app.js&#39;). Al incluir el servidor este se ejecuta, como podrás ver en la salida de la consola.</p>
<p>En código de test consiste en dos peticiones http y se comprueba que la respuesta sea la esperada. En el primer caso que sea realiza un redirect a la página de login. En el segundo caso qeu se haga un redirect a la página de inicio, comprobando además que se ha creado la cookie de sesión.</p>
<h1 id="test-de-integraci-n-con-phantomjs">Test de integración con PhantomJS</h1>
<p>Vamos a ir un paso más allá y vamos a añadir <a href="http://phantomjs.org/">PhantomJS</a>, un headless webkit. Nos va a permitir abrir páginas y ejecutar código javascript directamente en la página que estamos ejecutando. Instala el módulo y añádelo a las dependencias de test.</p>
<pre><code class="lang-bash"><span class="hljs-comment">$</span> <span class="hljs-comment">npm</span> <span class="hljs-comment">install</span> <span class="hljs-comment">node</span><span class="hljs-literal">-</span><span class="hljs-comment">phantom</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">save</span>
</code></pre>
<p>Añadimos un nuevos describe al fichero de test que teníamos</p>
<pre><code class="lang-js"><span class="hljs-keyword">var</span> phantom = <span class="hljs-keyword">require</span>(<span class="hljs-string">'node-phantom'</span>);

    describe(<span class="hljs-string">"page"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> {</span>
        <span class="hljs-keyword">var</span> ph;

        before(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> {</span>
            phantom.create(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, _ph)</span> {</span>
                ph = _ph;
                done();
            });
        });

        after(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            ph.<span class="hljs-keyword">exit</span>();
        });

        it(<span class="hljs-string">"should contains form with username &amp; password"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> {</span>
            ph.createPage(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, page)</span> {</span>
                page.open(<span class="hljs-string">"http://localhost:3000/login"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, status)</span> {</span>
                    page.evaluate(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                        <span class="hljs-keyword">var</span> result = {};
                        result.hasUsernameInput = $(<span class="hljs-string">'input[name="username"]'</span>).length &gt; <span class="hljs-number">0</span>;
                        result.hasPasswordInput = $(<span class="hljs-string">'input[name="password"]'</span>).length &gt; <span class="hljs-number">0</span>;
                        <span class="hljs-keyword">return</span> result;
                    }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, result)</span> {</span>
                        expect(result.hasUsernameInput).to.be.<span class="hljs-keyword">true</span>;
                        expect(result.hasPasswordInput).to.be.<span class="hljs-keyword">true</span>;
                        done();
                    });
                });
            });
        });

    });
</code></pre>
<p>En este test estamos abriendo la página de login y con la función <code>page.evaluate</code> estamos ejecutando código en la página web, por eso tenemos accesible jQuery y podemos ejecutar selectores sobre el código HTML de la página. Con los selectores estamos comprobando que existe un campo inputs para username y password.</p>
<p>Mocha se pone muy nervioso si alguien declara variables globales. En este caso phantom declara una variable global. Si queremos ejecutar nuestro test sin problemas</p>
<pre><code class="lang-bash"><span class="hljs-comment">$</span> <span class="hljs-comment">mocha</span> <span class="hljs-comment">test/integration/</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">globals</span> <span class="hljs-comment">location</span>
</code></pre>
<h1 id="ejercicio">Ejercicio</h1>
<p>Crea un test para la página de inicio que comprueba que aparece el nombre del usuario en pantalla. La página de inicio requiere login así que necesitarás primero setear una cookie.</p>
<p>Para añadir una cookie puedes utilizar el método <code>addCookie</code> de page. El valor de la cookie está obtenido del navegador</p>
<pre><code class="lang-js">                ph.addCookie({
                    'name':     'connect.sess',
                    'value':    's<span class="hljs-envvar">%3Aj%</span><span class="hljs-number">3</span>A<span class="hljs-envvar">%7B%</span><span class="hljs-number">22</span>username<span class="hljs-envvar">%22%</span><span class="hljs-number">3</span>A<span class="hljs-envvar">%22user1%</span><span class="hljs-number">22</span><span class="hljs-envvar">%2C%</span><span class="hljs-number">22</span>flash<span class="hljs-envvar">%22%</span><span class="hljs-number">3</span>A<span class="hljs-envvar">%7B%</span><span class="hljs-number">22</span>info<span class="hljs-envvar">%22%</span><span class="hljs-number">3</span>A<span class="hljs-envvar">%5B%</span><span class="hljs-number">22</span>welcome<span class="hljs-envvar">%20user1%</span><span class="hljs-number">22</span><span class="hljs-envvar">%5D%</span><span class="hljs-number">7</span>D%<span class="hljs-number">7</span>D.hv5tYPteWCgAl1uSG02vDSy6TEYcviBs2oN29pvN3IY',
                    'domain':   'localhost'
                });
</code></pre>
<h1 id="soluci-n">Solución</h1>
<p>Para facilitar un poco el test, modifiqué la página de inicio añadiendo una clase css para luego poder hacer el selector.</p>
<pre><code class="lang-jade">h1(<span class="hljs-keyword">class</span>=<span class="hljs-string">"welcome-username"</span>) Welcome <span class="hljs-keyword">to</span> <span class="hljs-preprocessor"></span>
</code></pre>
<pre><code class="lang-js">describe(<span class="hljs-string">"index"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>

    describe(<span class="hljs-string">"page"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> {</span>
        <span class="hljs-keyword">var</span> ph;

        before(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> {</span>
            phantom.create(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, _ph)</span> {</span>
                ph = _ph;

                ph.addCookie({
                    <span class="hljs-string">'name'</span>:     <span class="hljs-string">'connect.sess'</span>,
                    <span class="hljs-string">'value'</span>:    <span class="hljs-string">'s%3Aj%3A%7B%22username%22%3A%22user1%22%2C%22flash%22%3A%7B%22info%22%3A%5B%22welcome%20user1%22%5D%7D%7D.hv5tYPteWCgAl1uSG02vDSy6TEYcviBs2oN29pvN3IY'</span>,
                    <span class="hljs-string">'domain'</span>:   <span class="hljs-string">'localhost'</span>
                });

                done();
            });
        });

        after(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            ph.exit();
        });

        it(<span class="hljs-string">"should contains a title with the username"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> {</span>
            ph.createPage(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, page)</span> {</span>
                page.open(<span class="hljs-string">"http://localhost:3000"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, status)</span> {</span>
                    page.evaluate(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                        <span class="hljs-keyword">var</span> result = {};
                        result.title = $(<span class="hljs-string">".welcome-username"</span>).text();
                        <span class="hljs-keyword">return</span> result;
                    }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, result)</span> {</span>
                        expect(result.title).to.equal(<span class="hljs-string">"Welcome to user1"</span>);
                        done();
                    });
                });
            });
        });

    });
});
</code></pre>
<h1 id="referencias">Referencias</h1>
<ul>
<li><a href="http://sinonjs.org/docs/">Sinon.js</a></li>
<li><a href="https://github.com/alexscheelmeyer/node-phantom">node-phantom</a></li>
<li><a href="http://phantomjs.org/">Phantom.JS</a></li>
</ul>

  </div>
  <footer><a href="http://twitter.com/axelhzf" about="_blank">Twitter</a><a href="http://github.com/axelhzf" about="_blank">Github</a></footer>
</body>